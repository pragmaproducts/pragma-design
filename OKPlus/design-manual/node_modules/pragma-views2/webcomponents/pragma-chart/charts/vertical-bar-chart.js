import {loadScript} from "./../../component-loader.js";

class VerticalBarChart extends HTMLElement {
    get axisUI() {
        if(this._axisUI == undefined) {
            this._axisUI = this.parentElement.svg.append("g").attr("id", "chart-body")
        }

        return this._axisUI;
    }

    async connectedCallback() {
        const scriptPath = './third-party/d3.min.js';
        this._script = await loadScript(scriptPath, true, () => {
            this.parentElement.addChart(this);
            if (this._script != null) this._script.onload = null;
        });
    }

    disconnectedCallback() {
        this.parentElement.removeChart(this);
        delete this.axisUI;
        this._script = null;
    }


    update(data) {
        const padding = this.parentElement.paddingValues;
        const x = this.parentElement.xAxis.d3Scale;
        const y = this.parentElement.yAxis.d3Scale;

        const dataJoin = this.axisUI
            .selectAll(".bar")
            .data(data);

        const enter = dataJoin.enter()
            .append("rect")
            .attr("class", "bar")
            .attr("x", d => padding.left)
            .attr("y", d => y(d[this.parentElement.yAxis.field]) + padding.top)
            .attr("width", d => x(d[this.parentElement.xAxis.field]))
            .attr("height", this.parentElement.yAxis.itemWidth);

        dataJoin.exit().remove();

        dataJoin
            .merge(enter)
            .transition()
            .duration(100)
            .delay(100)
            .ease(d3.easeLinear)
            .attr("x", d => padding.left)
            .transition()
            .duration(500)
            .ease(d3.easeElastic)
            .attr("y", d => y(d[this.parentElement.yAxis.field]) + padding.top)
            .attr("width", d => {
                const w = x(d[this.parentElement.xAxis.field]);
                return w > 0 ? w : 0;
            })
            .attr("height", this.parentElement.yAxis.itemWidth)
    }
}

customElements.define("vertical-bar-chart", VerticalBarChart)
