
describe("Launch unit-tests-teamcity-generated.html", () => {

    let browserBasedMochaTestsDone = false;
    
    function whilstRunningTests() {        
        // Check on a 1s interval if the tests suite has finished.
        return new Promise(resolve => {
            let timer;
            timer = setInterval(() => {
                if (browserBasedMochaTestsDone) {
                    clearInterval(timer);
                    resolve();
                }                
            }, 1000);    
        });        
    }    
    
    it('RunUnitTests_NavigateToPage_Success', async () => {        
        // Arrange
        page.goto("https://127.0.0.1:1100/test/unit/unit-tests-teamcity-generated.html");

        // Act
        //  - Because start the test run in the browser we hook into the browser console and log those to the current
        //    context stdout.        
        page.on('console', msg => {
            for (let i = 0; i < msg.args().length; ++i) {
                const entry = `${msg.args()[i]}`;
                console.log(entry);
                if (entry.includes("##teamcity[testSuiteFinished name='mocha.suite'")) {
                    browserBasedMochaTestsDone = true;
                } 
            }
        });
        
        await whilstRunningTests();        
    });
});